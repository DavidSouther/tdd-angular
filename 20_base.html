<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="scripts.js"></script>
</head>

<body>
<div class="container"><div class="row">

<div class="col-md-8 col-md-offset-1">
	<h1><a href="http://www.obeythetestinggoat.com/">Obey the Testing Goat</a> <small><a href="https://github.com/DavidSouther/tdd-angular">NodeJS edition!</a></small></h1>

	<h2>The first actual features</h2>

	<p class="lead">In the second part of this walkthrough, we implement the first features of the todo app. </p>
</div>

<div class="col-md-8 col-md-offset-2">
	<div class="commit">
		<h3><span class="hash"><a href="https://github.com/DavidSouther/tdd-angular/tree/89ea624">89ea624</a></span>  Added bundle.</h3>
		<pre>
			<span class="nrm">.gitignore                |   1 </span><span class="add">+</span>
			<span class="nrm">Gruntfile.coffee          |  22 </span><span class="add">+++++++++</span><span class="rem">-</span>
			<span class="nrm">client/.gitignore         |   1 </span><span class="add">+</span>
			<span class="nrm">client/app/todo.coffee    |   4 </span><span class="add">++</span>
			<span class="nrm">client/main.coffee        |   1 </span><span class="add">+</span>
			<span class="nrm">package.json              |   8 </span><span class="add">+++</span><span class="rem">-</span>
			<span class="nrm">server/server.coffee      |   8 </span><span class="add">+++</span><span class="rem">-</span>
			<span class="nrm">server/test/serves.coffee | 100 </span><span class="add">++++++++++++++++++++++++++++</span><span class="rem">------------------</span>
			<span class="nrm">8 files changed, 102 insertions(+), 43 deletions(-)</span>
		</pre>

		<p>I am really bad at this. This is another two commits in one. The first half is using <a href="https://github.com/substack/node-browserify">Browserify</a> to build a javascript bundle during the build process. It works by taking a path to a single file, which <code>requires()</code> its dependencies. The second part is extending the server to return the compiled bundle on request.</p>

		<pre>
			<span class="wrn">diff --git a/Gruntfile.coffee b/Gruntfile.coffee</span>
			<span class="nfo">@@ -1,5 +1,16 @@</span>
			<span class="nrm">module.exports = (grunt)-&gt;</span>
			<span class="nrm">	grunt.initConfig</span>
			<span class="add">+		browserify:</span>
			<span class="add">+			dev:</span>
			<span class="add">+				files: &quot;client/bundle.js&quot;: [&quot;client/main.coffee&quot;]</span>
			<span class="add">+				options:</span>
			<span class="add">+					shim:</span>
			<span class="add">+						angular:</span>
			<span class="add">+							path: 'bower_components/angular/angular.js'</span>
			<span class="add">+							exports: 'angular'</span>
			<span class="add">+					transform: [</span>
			<span class="add">+						&quot;caching-coffeeify&quot;</span>
			<span class="add">+					]</span>
			<span class="nrm">		mochaTest:</span>
			<span class="nrm">			server:</span>
			<span class="nrm">				options:</span>
			<span class="nfo">@@ -25,14 +36,23 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm"></span>
			<span class="nrm">grunt.npmTasks = [</span>
			<span class="nrm">		&quot;grunt-cucumber&quot;</span>
			<span class="add">+		&quot;grunt-browserify&quot;</span>
			<span class="nrm">		&quot;grunt-mocha-test&quot;</span>
			<span class="nrm">		&quot;grunt-contrib-watch&quot;</span>
			<span class="nrm">	]</span>
			<span class="nrm"></span>
			<span class="nrm">grunt.loadNpmTasks npmTask for npmTask in grunt.npmTasks</span>
			<span class="nrm"></span>
			<span class="add">+	grunt.registerTask &quot;build&quot;, [</span>
			<span class="add">+		&quot;browserify:dev&quot;</span>
			<span class="add">+	]</span>
			<span class="add">+</span>
			<span class="nrm">	grunt.registerTask &quot;test&quot;, [</span>
			<span class="nrm">		&quot;mochaTest:server&quot;</span>
			<span class="nrm">		&quot;cucumberjs:Edith&quot;</span>
			<span class="nrm">	]</span>
			<span class="rem">-	grunt.registerTask &quot;default&quot;, [&quot;test&quot;]</span>
			<span class="add">+</span>
			<span class="add">+	grunt.registerTask &quot;default&quot;, [</span>
			<span class="add">+		&quot;build&quot;</span>
			<span class="add">+		&quot;test&quot;</span>
			<span class="add">+	]</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/main.coffee b/client/main.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1 @@</span>
			<span class="add">+todo = require &quot;./app/todo.coffee&quot;</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/app/todo.coffee b/client/app/todo.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1,4 @@</span>
			<span class="add">+angular =</span>
			<span class="add">+	module: (name, deps)-&gt;</span>
			<span class="add">+</span>
			<span class="add">+module.exports = todo = angular.module &quot;todo&quot;, []</span>
		</pre>

		<p>The second half of the commit is configuring the server to return the compiled bundles on request.</p>

		<pre>
			<span class="wrn">diff --git a/server/test/serves.coffee b/server/test/serves.coffee</span>
			<span class="nfo">@@ -1,46 +1,70 @@</span>
			<span class="nrm">should = require &quot;should&quot;</span>
			<span class="nrm">server = require &quot;../server&quot;</span>
			<span class="nrm">request = require &quot;request&quot;</span>
			<span class="add">+</span>
			<span class="add">+get = (path, d, cb)-&gt;</span>
			<span class="add">+	request path, (e, r, b)-&gt;</span>
			<span class="add">+		cb e, r, b</span>
			<span class="add">+		d()</span>
			<span class="add">+</span>
			<span class="add">+index = (d, cb)-&gt; get &quot;http://localhost:3000/&quot;, d, cb</span>
			<span class="add">+bundle = (d, cb)-&gt; get &quot;http://localhost:3000/bundle.js&quot;, d, cb</span>
			<span class="add">+</span>
			<span class="add">+Callbacks =</span>
			<span class="add">+	OK: (e, res)-&gt;</span>
			<span class="add">+		res.statusCode.should.equal 200</span>
			<span class="add">+</span>
			<span class="nrm">describe &quot;Server&quot;, -&gt;</span>
			<span class="rem">-	index = (d, cb)-&gt;</span>
			<span class="rem">-		request &quot;http://localhost:3000/&quot;, (e, r, b)-&gt;</span>
			<span class="rem">-			cb e, r, b</span>
			<span class="rem">-			d()</span>
			<span class="nrm"></span>
			<span class="nrm">before -&gt;</span>
			<span class="nrm">		server.serve()</span>
			<span class="nrm"></span>
			<span class="com">[...]</span>
			<span class="add">+	describe &quot;bundle.js&quot;, (done)-&gt;</span>
			<span class="add">+		it &quot;returns a bundle&quot;, (done)-&gt;</span>
			<span class="add">+			bundle done, Callbacks.OK</span>
			<span class="add">+</span>
			<span class="add">+		it &quot;returns a js bundle&quot;, (done)-&gt;</span>
			<span class="add">+			bundle done, (e, res)-&gt;</span>
			<span class="add">+				res.headers[&quot;content-type&quot;].should.equal &quot;text/javascript&quot;</span>
			<span class="add">+</span>
			<span class="add">+		it &quot;defines an Angular module&quot;, (done)-&gt;</span>
			<span class="add">+			bundle done, (e, r, body)-&gt;</span>
			<span class="add">+				body.should.match ///</span>
			<span class="add">+					angular\.module\(&quot;todo&quot;</span>
			<span class="add">+				///</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/server/server.coffee b/server/server.coffee</span>
			<span class="nfo">@@ -1,10 +1,14 @@</span>
			<span class="add">+path = require &quot;path&quot;</span>
			<span class="nrm">express = require &quot;express&quot;</span>
			<span class="nrm">app = express()</span>
			<span class="rem">-path = require &quot;path&quot;</span>
			<span class="add">+</span>
			<span class="add">+app.get '/bundle.js', (req, res)-&gt;</span>
			<span class="add">+	res.set &quot;content-type&quot;, &quot;text/javascript&quot;</span>
			<span class="add">+	res.sendfile path.join __dirname, &quot;..&quot;, &quot;client&quot;, &quot;bundle.js&quot;</span>
			<span class="nrm"></span>
			<span class="nrm">app.get '/', (req, res)-&gt;</span>
			<span class="nrm">	res.sendfile path.join __dirname, &quot;..&quot;, &quot;client&quot;, &quot;index.html&quot;</span>
		</pre>
	</div>


	<div class="commit">
		<h3><span class="hash"><a href="https://github.com/DavidSouther/tdd-angular/tree/ae98607">ae98607</a></span>  Basic Karma test.</h3>
		<pre>
			<span class="nrm">Gruntfile.coffee       | 21 </span><span class="add">+++++++++++++++++</span><span class="rem">----</span>
			<span class="nrm">client/app/test.coffee | 10 </span><span class="add">++++++++++</span>
			<span class="nrm">client/app/todo.coffee |  7 </span><span class="add">++++</span><span class="rem">---</span>
			<span class="nrm">package.json           |  4 </span><span class="add">+++</span><span class="rem">-</span>
			<span class="nrm">4 files changed, 34 insertions(+), 8 deletions(-)</span>
		</pre>

		<p>An Angular test, and Angular code! In grunt, we switch from compiling Angular into the bundle to including Angular from CDN on its own (in this case, "CDN" is our bower install directory). The test is in Karma, and runs in the browser. That said, these are Angular unit tests, working each piece of the module in isolation. This first commit is just enough code to show that Karma runs reasonably.</p>

		<pre>
			<span class="wrn">diff --git a/Gruntfile.coffee b/Gruntfile.coffee</span>
			<span class="nfo">@@ -4,13 +4,24 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm">			dev:</span>
			<span class="nrm">				files: &quot;client/bundle.js&quot;: [&quot;client/main.coffee&quot;]</span>
			<span class="nrm">				options:</span>
			<span class="rem">-					shim:</span>
			<span class="rem">-						angular:</span>
			<span class="rem">-							path: 'bower_components/angular/angular.js'</span>
			<span class="rem">-							exports: 'angular'</span>
			<span class="add">+					debug: true</span>
			<span class="nrm">					transform: [</span>
			<span class="nrm">						&quot;caching-coffeeify&quot;</span>
			<span class="nrm">					]</span>
			<span class="add">+</span>
			<span class="add">+		karma:</span>
			<span class="add">+			unit:</span>
			<span class="add">+				options:</span>
			<span class="add">+					browsers: [&quot;PhantomJS&quot;]</span>
			<span class="add">+					frameworks: [&quot;jasmine&quot;]</span>
			<span class="add">+					singleRun: true</span>
			<span class="add">+					files: [</span>
			<span class="add">+							&quot;bower_components/angular/angular.js&quot;</span>
			<span class="add">+							&quot;bower_components/angular-mocks/angular-mocks.js&quot;</span>
			<span class="add">+							&quot;client/bundle.js&quot;</span>
			<span class="add">+							&quot;client/app/**/test.coffee&quot;</span>
			<span class="add">+						]</span>
			<span class="add">+</span>
			<span class="nrm">		mochaTest:</span>
			<span class="nrm">			server:</span>
			<span class="nrm">				options:</span>
			<span class="nfo">@@ -36,6 +47,7 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm"></span>
			<span class="nrm">grunt.npmTasks = [</span>
			<span class="nrm">		&quot;grunt-cucumber&quot;</span>
			<span class="add">+		&quot;grunt-karma&quot;</span>
			<span class="nrm">		&quot;grunt-browserify&quot;</span>
			<span class="nrm">		&quot;grunt-mocha-test&quot;</span>
			<span class="nrm">		&quot;grunt-contrib-watch&quot;</span>
			<span class="nfo">@@ -49,6 +61,7 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm"></span>
			<span class="nrm">grunt.registerTask &quot;test&quot;, [</span>
			<span class="nrm">		&quot;mochaTest:server&quot;</span>
			<span class="add">+		&quot;karma:unit&quot;</span>
			<span class="nrm">		&quot;cucumberjs:Edith&quot;</span>
			<span class="nrm">	]</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/app/test.coffee b/client/app/test.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1,10 @@</span>
			<span class="add">+describe &quot;todo bootstrap&quot;, -&gt;</span>
			<span class="add">+	beforeEach module &quot;todo&quot;</span>
			<span class="add">+</span>
			<span class="add">+	$scope = null</span>
			<span class="add">+	beforeEach inject ($rootScope, $controller)-&gt;</span>
			<span class="add">+		$scope = $rootScope.$new()</span>
			<span class="add">+		$controller &quot;todo&quot;, {$scope}</span>
			<span class="add">+</span>
			<span class="add">+	it &quot;exposes todo lists&quot;, -&gt;</span>
			<span class="add">+		expect($scope.todos).toEqual([])</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/app/todo.coffee b/client/app/todo.coffee</span>
			<span class="nfo">@@ -1,4 +1,5 @@</span>
			<span class="rem">-angular =</span>
			<span class="rem">-	module: (name, deps)-&gt;</span>
			<span class="rem">-</span>
			<span class="nrm">module.exports = todo = angular.module &quot;todo&quot;, []</span>
			<span class="add">+</span>
			<span class="add">+angular.module(&quot;todo&quot;)</span>
			<span class="add">+.controller &quot;todo&quot;, ($scope)-&gt;</span>
			<span class="add">+	$scope.todos = []</span>
		</pre>
	</div>

	<div class="commit">
		<h3><span class="hash"><a href="https://github.com/DavidSouther/tdd-angular/tree/41b7f98">41b7f98</a></span>  Serves visibly working client...</h3>

		<pre>
			<span class="nrm">Gruntfile.coffee          | 10 </span><span class="add">+++++</span><span class="rem">-----</span>
			<span class="nrm">client/app/test.coffee    | 10 </span><span class="rem">----------</span>
			<span class="nrm">client/app/todo.coffee    |  5 </span><span class="rem">-----</span>
			<span class="nrm">client/index.html         | 13 </span><span class="add">++++++++++</span><span class="rem">---</span>
			<span class="nrm">client/main.coffee        |  2 </span><span class="add">+</span><span class="rem">-</span>
			<span class="nrm">client/todo/module.coffee |  9 </span><span class="add">+++++++++</span>
			<span class="nrm">client/todo/unit.coffee   | 20 </span><span class="add">++++++++++++++++++++</span>
			<span class="nrm">package.json              |  4 </span><span class="add">+</span><span class="rem">---</span>
			<span class="nrm">server/server.coffee      |  4 </span><span class="add">++++</span>
			<span class="nrm">server/test/serves.coffee |  8 </span><span class="add">+++++++</span><span class="rem">-</span>
			<span class="nrm">10 files changed, 57 insertions(+), 28 deletions(-)</span>
		</pre>

		<p>A three-for-one! Expanding the index.html to include the angular view code, tests for that code (I promise the tests were written first), and the server code to return bundles and bower resources. And a refactor. So four commits in one.</p>

		<pre>
			<span class="wrn">diff --git a/client/index.html b/client/index.html</span>
			<span class="nfo">@@ -1,13 +1,20 @@</span>
			<span class="nrm">&lt;html&gt;</span>
			<span class="nrm">&lt;head&gt;</span>
			<span class="nrm">	&lt;title&gt;To Do - Angular JS&lt;/title&gt;</span>
			<span class="add">+	&lt;script src=&quot;bower/angular/angular.js&quot;&gt;&lt;/script&gt;</span>
			<span class="add">+	&lt;script src=&quot;bundle.js&quot;&gt;&lt;/script&gt;</span>
			<span class="nrm">&lt;/head&gt;</span>
			<span class="rem">-&lt;body&gt;</span>
			<span class="add">+&lt;body ng:app=&quot;todo&quot;&gt;</span>
			<span class="nrm">	&lt;header&gt;</span>
			<span class="nrm">		&lt;h1&gt;To Do&lt;/h1&gt;</span>
			<span class="nrm">	&lt;/header&gt;</span>
			<span class="rem">-	&lt;section&gt;</span>
			<span class="rem">-		&lt;input type=&quot;text&quot; name=&quot;to-do&quot; placeholder=&quot;to-do&quot; /&gt;</span>
			<span class="add">+	&lt;section ng:controller=&quot;todo&quot;&gt;</span>
			<span class="add">+		&lt;form ng:submit=&quot;Todos.add()&quot;&gt;</span>
			<span class="add">+			&lt;input type=&quot;text&quot; name=&quot;to-do&quot; placeholder=&quot;to-do&quot; ng:model=&quot;Todos.current&quot; ng: /&gt;</span>
			<span class="add">+		&lt;/form&gt;</span>
			<span class="add">+		&lt;ol&gt;</span>
			<span class="add">+			&lt;li ng:repeat=&quot;todo in todos&quot;&gt;{{todo}}&lt;/li&gt;</span>
			<span class="add">+		&lt;/ol&gt;</span>
			<span class="nrm">	&lt;/section&gt;</span>
			<span class="nrm">&lt;/body&gt;</span>
			<span class="nrm">&lt;/html&gt;</span>
			<span class="nrm">\ No newline at end of file</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/main.coffee b/client/main.coffee</span>
			<span class="nfo">@@ -1 +1 @@</span>
			<span class="rem">-todo = require &quot;./app/todo.coffee&quot;</span>
			<span class="add">+todo = require &quot;./todo/module.coffee&quot;</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/todo/module.coffee b/client/todo/module.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1,9 @@</span>
			<span class="add">+module.exports = todo = angular.module &quot;todo&quot;, []</span>
			<span class="add">+</span>
			<span class="add">+todo.controller &quot;todo&quot;, ($scope)-&gt;</span>
			<span class="add">+	$scope.todos = []</span>
			<span class="add">+	Todos = $scope.Todos =</span>
			<span class="add">+		current: &quot;&quot;</span>
			<span class="add">+		add: -&gt;</span>
			<span class="add">+			$scope.todos.push Todos.current</span>
			<span class="add">+			Todos.current = &quot;&quot;</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/client/todo/unit.coffee b/client/todo/unit.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1,20 @@</span>
			<span class="add">+describe &quot;todo controller&quot;, -&gt;</span>
			<span class="add">+	beforeEach module &quot;todo&quot;</span>
			<span class="add">+</span>
			<span class="add">+	$scope = null</span>
			<span class="add">+	beforeEach inject ($rootScope, $controller)-&gt;</span>
			<span class="add">+		$scope = $rootScope.$new()</span>
			<span class="add">+		$controller &quot;todo&quot;, {$scope}</span>
			<span class="add">+</span>
			<span class="add">+	it &quot;exposes todos&quot;, -&gt;</span>
			<span class="add">+		expect($scope.todos).toEqual([], &quot;todos should be array&quot;)</span>
			<span class="add">+		expect($scope.Todos).toBeDefined(&quot;Todos should be object&quot;)</span>
			<span class="add">+		expect($scope.Todos.current).toBe(&quot;&quot;, &quot;Todos should have current (empty) reference&quot;)</span>
			<span class="add">+		expect(typeof $scope.Todos.add).toBe(&quot;function&quot;, &quot;Todos.add should be function&quot;)</span>
			<span class="add">+</span>
			<span class="add">+	it &quot;can add todo&quot;, -&gt;</span>
			<span class="add">+		$scope.Todos.current = &quot;Todo 1&quot;</span>
			<span class="add">+		$scope.Todos.add()</span>
			<span class="add">+		expect($scope.todos.length).toEqual(1, &quot;After adding, todos has single todo&quot;)</span>
			<span class="add">+		expect($scope.todos[0]).toEqual(&quot;Todo 1&quot;, &quot;Correct Todo was added&quot;)</span>
			<span class="add">+		expect($scope.Todos.current).toEqual(&quot;&quot;, &quot;Resets current todo&quot;)</span>
			<span class="nrm">\ No newline at end of file</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/server/server.coffee b/server/server.coffee</span>
			<span class="nfo">@@ -6,6 +6,10 @@</span> app.get '/bundle.js', (req, res)-&gt;
			<span class="nrm">	res.set &quot;content-type&quot;, &quot;text/javascript&quot;</span>
			<span class="nrm">	res.sendfile path.join __dirname, &quot;..&quot;, &quot;client&quot;, &quot;bundle.js&quot;</span>
			<span class="add">+app.get '/bower/:module/:file', (req, res)-&gt;</span>
			<span class="add">+	res.set &quot;content-type&quot;, &quot;text/javascript&quot;</span>
			<span class="add">+	res.sendfile path.join __dirname, &quot;..&quot;, &quot;bower_components&quot;, req.params.module, req.params.file</span><span class="reverse"><span class="hash">	</span>
			<span class="add">+</span>
			<span class="nrm">app.get '/', (req, res)-&gt;</span>
			<span class="nrm">	res.sendfile path.join __dirname, &quot;..&quot;, &quot;client&quot;, &quot;index.html&quot;</span>
		</pre>

		<pre>
			<span class="wrn">diff --git a/server/test/serves.coffee b/server/test/serves.coffee</span>
			<span class="nfo">@@ -55,7 +55,7 @@</span> describe &quot;Server&quot;, -&gt;
			<span class="nrm">				should.exist matches</span>
			<span class="nrm">				matches[1].should.match /to-do/</span>
			<span class="rem">-	describe &quot;bundle.js&quot;, (done)-&gt;</span>
			<span class="add">+	describe &quot;bundle.js&quot;, -&gt;</span>
			<span class="nrm">		it &quot;returns a bundle&quot;, (done)-&gt;</span>
			<span class="nrm">			bundle done, Callbacks.OK</span>
			<span class="nfo">@@ -68,3 +68,9 @@</span> describe &quot;Server&quot;, -&gt;
			<span class="nrm">				body.should.match ///</span>
			<span class="nrm">					angular\.module\(&quot;todo&quot;</span>
			<span class="nrm">				///</span>
			<span class="add">+</span>
			<span class="add">+	describe &quot;bower&quot;, -&gt;</span>
			<span class="add">+		it &quot;serves Bower resources&quot;, (done)-&gt;</span>
			<span class="add">+			request &quot;http://localhost:3000/bower/angular/angular.js&quot;, (e, res)-&gt;</span>
			<span class="add">+				res.statusCode.should.equal 200</span>
			<span class="add">+				done()</span>
		</pre>
	</div>

	<div class="commit">
		<h3><span class="hash"><a href="https://github.com/DavidSouther/tdd-angular/tree/5981165">5981165</a></span>  Support for running selenium in cucumber.</h3>

		<pre>
			<span class="nrm">.gitignore       |  1 </span><span class="add">+</span>
			<span class="nrm">Gruntfile.coffee | 29 </span><span class="add">++++++++++++++++++++++++++++</span><span class="rem">-</span>
			<span class="nrm">package.json     |  7 </span><span class="add">++++++</span><span class="rem">-</span>
			<span class="nrm">3 files changed, 35 insertions(+), 2 deletions(-)</span>
		</pre>

		<p>This is where things got interesting again from the standpoint of refactoring the Grunt file. I hadn't looked at the gherkin world support yet, because it was written using Zombie. Zombie seemed to work great for basic HTML applications, but I couldn't get it to work with AngularJS apps. Instead, I am switching to Angular Protractor, which is built on top of WebdriverJS for the Selenium browser automation framework.</p>

		<pre>
			<span class="wrn">diff --git a/Gruntfile.coffee b/Gruntfile.coffee</span>
			<span class="nfo">@@ -28,6 +28,22 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm">					reporter: 'spec'</span>
			<span class="nrm">				src: [&quot;server/test/*coffee&quot;]</span>
			<span class="nrm"></span>
			<span class="add">+		shell:</span>
			<span class="add">+			kill:</span>
			<span class="add">+				command: &quot;lsof -i TCP -P | grep 4444 | awk '{print $2}' | xargs -I{} kill {} &gt;/dev/null  || exit 0&quot;</span>
			<span class="add">+			selenium:</span>
			<span class="add">+				command: [</span>
			<span class="add">+					&quot;java -jar ./selenium/selenium-server-standalone-2.34.0.jar &quot;</span>
			<span class="add">+					&quot;-Dwebdriver.chrome.driver=./selenium/chromedriver &quot;</span>
			<span class="add">+					&quot;&gt;/dev/null&quot;</span>
			<span class="add">+				].join ' '</span>
			<span class="add">+				options:</span>
			<span class="add">+					async: true</span>
			<span class="add">+					kill: true</span>
			<span class="add">+			sleep:</span>
			<span class="add">+				command:</span>
			<span class="add">+					&quot;sleep 1&quot;</span>
			<span class="add">+</span>
			<span class="nrm">		cucumberjs:</span>
			<span class="nrm">			Edith:</span>
			<span class="nrm">				files: src: ['test/behavior/users/edith']</span>
			<span class="nfo">@@ -38,6 +54,7 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm">			all:</span>
			<span class="nrm">				files: [</span>
			<span class="nrm">					'test/**/*coffee'</span>
			<span class="add">+					'test/**/*feature'</span>
			<span class="nrm">					'server/**/*coffee'</span>
			<span class="nrm">					'client/**/*html'</span>
			<span class="nrm">					'client/**/*coffee'</span>
			<span class="nfo">@@ -48,6 +65,7 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm">	grunt.npmTasks = [</span>
			<span class="nrm">		&quot;grunt-cucumber&quot;</span>
			<span class="nrm">		&quot;grunt-karma&quot;</span>
			<span class="add">+		&quot;grunt-shell-spawn&quot;</span>
			<span class="nrm">		&quot;grunt-browserify&quot;</span>
			<span class="nrm">		&quot;grunt-mocha-test&quot;</span>
			<span class="nrm">		&quot;grunt-contrib-watch&quot;</span>
			<span class="nfo">@@ -59,10 +77,19 @@</span> module.exports = (grunt)-&gt;
			<span class="nrm">		&quot;browserify:dev&quot;</span>
			<span class="nrm">	]</span>
			<span class="nrm"></span>
			<span class="add">+	grunt.registerTask &quot;features&quot;, [</span>
			<span class="add">+		&quot;shell:kill&quot; # Clean up any old selenium servers, or other programs who may be hogging 4444</span>
			<span class="add">+		&quot;shell:selenium&quot;</span>
			<span class="add">+		&quot;shell:sleep&quot;</span>
			<span class="add">+		&quot;cucumberjs:Edith&quot;</span>
			<span class="add">+		&quot;shell:selenium:kill&quot; # Stop the selenium server</span>
			<span class="add">+		&quot;shell:kill&quot; # Also has the effect of killing driven browsers.</span>
			<span class="add">+	]</span>
			<span class="add">+</span>
			<span class="nrm">	grunt.registerTask &quot;test&quot;, [</span>
			<span class="nrm">		&quot;mochaTest:server&quot;</span>
			<span class="nrm">		&quot;karma:unit&quot;</span>
			<span class="rem">-		&quot;cucumberjs:Edith&quot;</span>
			<span class="add">+		&quot;features&quot;</span>
			<span class="nrm">	]</span>
			<span class="nrm"></span>
			<span class="nrm">grunt.registerTask &quot;default&quot;, [</span>
		</pre>

		<p>Holy shell spawn, Batman! The Selenium Server is a Java program, so running it is a lot of java commands through the shell, along with some process control for when things start getting unruly.</p>

	</div>

	<div class="commit">
		<h3><span class="hash"><a href="https://github.com/DavidSouther/tdd-angular/tree/a976bbd">a976bbd</a></span>  Updated world tests.</h3>

		<pre>
			<span class="nrm">test/behavior/steps/browsing.coffee            | 87 </span><span class="add">+++++++++++++++++</span><span class="rem">---------</span>
			<span class="nrm">test/behavior/support/world.coffee             | 17 </span><span class="rem">-----</span>
			<span class="nrm">test/behavior/support/worlds.coffee            |  2 </span><span class="add">+</span>
			<span class="nrm">test/behavior/support/worlds/protractor.coffee | 40 </span><span class="add">++++++++++++</span>
			<span class="nrm">test/behavior/support/worlds/zombie.coffee     | 21 </span><span class="add">+++++++</span>
			<span class="nrm">test/behavior/users/edith/Edith.feature        | 45 </span><span class="add">++++++</span><span class="rem">-------</span>
			<span class="nrm">6 files changed, 144 insertions(+), 68 deletions(-)</span>
		</pre>

		<p>And here is the Protractor world!

		<pre>
			<span class="wrn">diff --git a/test/behavior/steps/browsing.coffee b/test/behavior/steps/browsing.coffee</span>
			<span class="nfo">@@ -1,43 +1,70 @@</span>
			<span class="add">+Q = require 'q'</span>
			<span class="nrm">should = require &quot;should&quot;</span>
			<span class="rem">-World = require &quot;../support/world&quot;</span>
			<span class="add">+World = require &quot;../support/worlds&quot;</span>
			<span class="nrm">module.exports = -&gt;</span>
			<span class="rem">-	@Given /has (?:his|her|a) browser open$/, (cb)-&gt;</span>
			<span class="add">+	@Before (done)-&gt;</span>
			<span class="nrm">		# opening a browser is like entering a whole new world...</span>
			<span class="nrm">		@world = new World()</span>
			<span class="rem">-		cb()</span>
			<span class="add">+		done()</span>
			<span class="nrm"></span>
			<span class="rem">-	@Given /on the landing page/, (cb)-&gt;</span>
			<span class="rem">-		@world = new World()</span>
			<span class="add">+	@After (done)-&gt;</span>
			<span class="add">+		@world?.destroy()</span>
			<span class="add">+		done()</span>
			<span class="add">+</span>
			<span class="add">+	@Given /has (?:his|her|a) browser open$/, (done)-&gt;</span>
			<span class="add">+		done()</span>
			<span class="add">+</span>
			<span class="add">+	@Given /on the landing page/, (done)-&gt;</span>
			<span class="nrm">		@world.visit(&quot;http://localhost:3000/&quot;)</span>
			<span class="rem">-		.then cb</span>
			<span class="add">+		.then(done)</span>
			<span class="nrm"></span>
			<span class="rem">-	@When /goes to the (?:site|landing page)(?: directly)?/, (callback) -&gt;</span>
			<span class="add">+	@When /goes to the (?:site|landing page)(?: directly)?/, (done) -&gt;</span>
			<span class="nrm">		@world.visit(&quot;http://localhost:3000/&quot;)</span>
			<span class="rem">-		.then callback</span>
			<span class="add">+		.then(done)</span>
			<span class="nrm"></span>
			<span class="rem">-	@When /enters &quot;([^&quot;]+)&quot; into the &quot;([^&quot;]+)&quot; (?:box|input|field)/, (value, field, cb)-&gt;</span>
			<span class="rem">-		@world.fill(field, value)</span>
			<span class="rem">-		cb()</span>
			<span class="add">+	@When /enters &quot;([^&quot;]+)&quot; into (?:the|a) &quot;([^&quot;]+)&quot; (?:box|input|field)/, (value, field, done)-&gt;</span>
			<span class="add">+		@world.fill(field, value, true)</span>
			<span class="add">+		.then(-&gt;done())</span>
			<span class="add">+		.catch(done)</span>
			<span class="add">+</span>
			<span class="add">+	@When /enters into (?:the|a) &quot;([^&quot;]+)&quot; (?:box|input|field)/, (field, lines, done)-&gt;</span>
			<span class="add">+		Q.all([@world.fill(field, line, true) for line in lines.split '\n'])</span>
			<span class="add">+		.then(-&gt;done())</span>
			<span class="add">+		.catch(done)</span>
			<span class="add">+</span>
			<span class="add">+	###</span>
			<span class="add">+	Check for existance of a string in the title</span>
			<span class="add">+	###</span>
			<span class="add">+	@Then /should see &quot;([^&quot;]*)&quot; in (?:the )title$/, (what, done) -&gt;</span>
			<span class="add">+		@world.title()</span>
			<span class="add">+		.then (text)-&gt;</span>
			<span class="add">+			text.indexOf(what).should.be.greaterThan -1,</span>
			<span class="add">+				&quot;'#{what}' expected in title&quot;</span>
			<span class="add">+			done()</span>
			<span class="add">+		.catch done</span>
			<span class="nrm"></span>
			<span class="nrm">###</span>
			<span class="nrm">	Check for existance of a string in a selector</span>
			<span class="nrm">	###</span>
			<span class="rem">-	@Then /should see &quot;([^&quot;]*)&quot; in (?:the )&quot;([^&quot;]*)&quot;$/, (what, where, callback) -&gt;</span>
			<span class="rem">-		@world.text(where).indexOf(what).should.be.greaterThan -1,</span>
			<span class="rem">-			&quot;'#{what}' expected in '#{where}'&quot;</span>
			<span class="rem">-		callback()</span>
			<span class="rem">-</span>
			<span class="rem">-	@Then /invited to enter a &quot;([^&quot;]*)&quot;/, (value, callback)-&gt;</span>
			<span class="rem">-		inputs = @world.find(&quot;input[type=text]&quot;)</span>
			<span class="rem">-		inputs.length.should.equal 1,</span>
			<span class="rem">-			&quot;One text input must exist.&quot;</span>
			<span class="rem">-		placeholder = inputs[0].getAttribute('placeholder')</span>
			<span class="rem">-		should.exist placeholder,</span>
			<span class="rem">-			&quot;Input should have placeholder.&quot;</span>
			<span class="rem">-		placeholder.should.match ///#{value}///,</span>
			<span class="rem">-			&quot;Placeholder should be inviting.&quot;</span>
			<span class="rem">-		callback()</span>
			<span class="rem">-</span>
			<span class="rem">-	@Then /page shows &quot;([^&quot;]+)&quot;/, (content)-&gt;</span>
			<span class="rem">-		text = @world.text(&quot;body&quot;)</span>
			<span class="rem">-		text.should.match ///#{content}///</span>
			<span class="add">+	@Then /should see &quot;([^&quot;]*)&quot; in (?:the )&quot;([^&quot;]*)&quot;$/, (what, where, done) -&gt;</span>
			<span class="add">+		@world.text(where)</span>
			<span class="add">+		.then (text)-&gt;</span>
			<span class="add">+			text.indexOf(what).should.be.greaterThan -1,</span>
			<span class="add">+				&quot;'#{what}' expected in '#{where}'&quot;</span>
			<span class="add">+			done()</span>
			<span class="add">+		.catch done</span><span class="reverse"><span class="hash"> </span>
			<span class="add">+</span>
			<span class="add">+	@Then /invited to enter a(?:nother)? &quot;([^&quot;]*)&quot;/, (value, done)-&gt;</span>
			<span class="add">+		@world.placeholder(&quot;input[type=text]&quot;)</span>
			<span class="add">+		.then (placeholder)-&gt;</span>
			<span class="add">+			placeholder.should.match ///#{value}///,</span>
			<span class="add">+				&quot;placeholder should be inviting.&quot;</span>
			<span class="add">+			done()</span>
			<span class="add">+		.catch done</span>
			<span class="add">+</span>
			<span class="add">+	@Then /page shows &quot;([^&quot;]+)&quot;/, (content, done)-&gt;</span>
			<span class="add">+		@world.text(&quot;body&quot;)</span>
			<span class="add">+		.then (text)-&gt;</span>
			<span class="add">+			text.should.match ///#{content}///</span>
			<span class="add">+			done()</span>
			<span class="add">+		.catch done</span>
		</pre>

		<p>The biggest change is the handling of the callback. The Cucumber signature is <code>callback([err])</code>, where passing anything to the callback results in the step failing, and calling the callback with no arguments is a success. I prefer a deferred async style, so massaging the Q callbacks around the cucumber callback takes some jumping though hoops. I would like to make this more sensible in the future.</p>

		<pre>
			<span class="wrn">diff --git a/test/behavior/support/worlds/protractor.coffee b/test/behavior/support/worlds/protractor.coffee</span>
			<span class="wrn">new file mode 100644</span>
			<span class="nfo">@@ -0,0 +1,40 @@</span>
			<span class="add">+Q = require &quot;q&quot;</span>
			<span class="add">+should = require &quot;should&quot;</span>
			<span class="add">+webdriver = require &quot;selenium-webdriver&quot;</span>
			<span class="add">+Protractor = require &quot;protractor&quot;</span>
			<span class="add">+By = Protractor.By</span>
			<span class="add">+</span>
			<span class="add">+module.exports = class World</span>
			<span class="add">+	constructor: -&gt;</span>
			<span class="add">+		@driver = new webdriver.Builder().</span>
			<span class="add">+			usingServer('http://localhost:4444/wd/hub').</span>
			<span class="add">+			withCapabilities(webdriver.Capabilities.firefox()).build();</span>
			<span class="add">+</span>
			<span class="add">+		@driver.manage().timeouts().setScriptTimeout(10000);</span>
			<span class="add">+		@ptor = Protractor.wrapDriver(@driver);</span>
			<span class="add">+</span>
			<span class="add">+	visit: (url)-&gt;</span>
			<span class="add">+		Q @ptor.get(url)</span>
			<span class="add">+</span>
			<span class="add">+	find: (selector)-&gt;</span>
			<span class="add">+		@ptor.findElement By.css selector</span>
			<span class="add">+</span>
			<span class="add">+	text: (where)-&gt;</span>
			<span class="add">+		Q @find(where).getText()</span>
			<span class="add">+</span>
			<span class="add">+	title: -&gt;</span>
			<span class="add">+		Q @ptor.getTitle()</span>
			<span class="add">+</span>
			<span class="add">+	placeholder: (where)-&gt;</span>
			<span class="add">+		Q @find(where).getAttribute 'placeholder'</span>
			<span class="add">+</span>
			<span class="add">+	fill: (what, value, submit = false)-&gt;</span>
			<span class="add">+		input = @ptor.findElement(By.name(what))</span>
			<span class="add">+		deferred = input.sendKeys(value)</span>
			<span class="add">+		if submit</span>
			<span class="add">+			deferred.then -&gt;</span>
			<span class="add">+				input.submit()</span>
			<span class="add">+		Q deferred</span>
			<span class="add">+</span>
			<span class="add">+	destroy: (done)-&gt;</span>
			<span class="add">+		@driver.quit()</span>
		</pre>

		<p>The underlying world is pretty straight forward, connecting to Selenium on the port the Gruntfile launched it on, and passing the various step commands through sensibly. Facade would be the design patterns phrase.</p>

		<h2><a href="30_mvp.html">Onward, to an MVP!</a></h2>
	</div>

</div></div></div>
</body>
</html>
